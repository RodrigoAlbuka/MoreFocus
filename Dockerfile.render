# MoreFocus - Dockerfile para Render.com
# Otimizado para deploy na plataforma Render

FROM n8nio/n8n:latest

# Metadados
LABEL maintainer="MoreFocus Team <morefocusbr@gmail.com>"
LABEL version="1.0.0-render"
LABEL description="MoreFocus - Automa√ß√£o RPA para Render.com"

# Usar usu√°rio root para configura√ß√µes
USER root

# Instalar depend√™ncias necess√°rias
RUN apt-get update && apt-get install -y \
    wget \
    curl \
    git \
    bash \
    && rm -rf /var/lib/apt/lists/*

# Criar diret√≥rios
RUN mkdir -p /opt/morefocus/workflows \
    && mkdir -p /opt/morefocus/backups

# Copiar workflows
COPY workflows/ /opt/morefocus/workflows/

# Criar script de inicializa√ß√£o para Render
RUN cat > /opt/morefocus/start-render.sh << 'EOF'
#!/bin/bash

echo "üöÄ Iniciando MoreFocus no Render..."

# Configurar vari√°veis para Render
export N8N_HOST=${N8N_HOST:-0.0.0.0}
export N8N_PORT=${N8N_PORT:-10000}
export N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-true}
export N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-admin}
export N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:-MoreFocus2024!}
export WEBHOOK_URL=${WEBHOOK_URL:-https://morefocus.onrender.com/}
export GENERIC_TIMEZONE=${GENERIC_TIMEZONE:-America/Sao_Paulo}
export DB_TYPE=${DB_TYPE:-sqlite}
export DB_SQLITE_DATABASE=${DB_SQLITE_DATABASE:-/home/node/.n8n/database.sqlite}

# Criar diret√≥rio .n8n se n√£o existir
mkdir -p /home/node/.n8n/workflows

# Copiar workflows se existirem
if [ -d "/opt/morefocus/workflows" ] && [ "$(ls -A /opt/morefocus/workflows/*.json 2>/dev/null)" ]; then
    echo "üì• Importando workflows..."
    cp /opt/morefocus/workflows/*.json /home/node/.n8n/workflows/ 2>/dev/null || true
fi

# Configurar permiss√µes
chown -R node:node /home/node/.n8n

echo "‚úÖ Configura√ß√£o conclu√≠da!"
echo "üåê Acess√≠vel em: $WEBHOOK_URL"
echo "üë§ Usu√°rio: $N8N_BASIC_AUTH_USER"

# Iniciar n8n como usu√°rio node
exec su-exec node n8n start
EOF

# Tornar execut√°vel
RUN chmod +x /opt/morefocus/start-render.sh

# Configurar permiss√µes
RUN chown -R node:node /opt/morefocus

# Voltar para usu√°rio node
USER node

# Vari√°veis de ambiente para Render
ENV NODE_ENV=production
ENV N8N_HOST=0.0.0.0
ENV N8N_PORT=10000
ENV N8N_PROTOCOL=http
ENV GENERIC_TIMEZONE=America/Sao_Paulo
ENV N8N_LOG_LEVEL=info
ENV N8N_DIAGNOSTICS_ENABLED=false
ENV N8N_VERSION_NOTIFICATIONS_ENABLED=false
ENV N8N_RUNNERS_ENABLED=true
ENV N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=false

# Expor porta do Render
EXPOSE 10000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD wget --quiet --tries=1 --spider http://localhost:10000/healthz || exit 1

# Volume para dados
VOLUME ["/home/node/.n8n"]

# Comando de inicializa√ß√£o
CMD ["/opt/morefocus/start-render.sh"]

